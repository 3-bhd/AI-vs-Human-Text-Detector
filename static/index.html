<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI vs Human Text Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 900px;
      width: 100%;
      padding: 2rem;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 1.75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid #1e293b;
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.7rem;
    }

    .subtitle {
      margin: 0 0 1.5rem;
      color: #9ca3af;
      font-size: 0.95rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: #cbd5f5;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      padding: 0.75rem 0.9rem;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.5;
      box-sizing: border-box;
    }

    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    .hint {
      margin-top: 0.2rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .controls {
      margin-top: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.4rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    .status {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .result-card {
      margin-top: 1.5rem;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
    }

    .result-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    .result-label {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .result-label.ai {
      color: #fb7185; /* pink-red for AI */
    }

    .result-label.human {
      color: #22c55e; /* green for Human */
    }

    .result-meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .error {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: #f97373;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      border: 1px solid #1f2937;
      color: #9ca3af;
      gap: 0.25rem;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }

    /* Feedback section styles */
    .feedback-section {
      margin-top: 1.1rem;
      padding-top: 0.9rem;
      border-top: 1px solid #1f2937;
    }

    .feedback-title {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    .feedback-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    select {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
    }

    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    /* Admin section */
    .admin-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px dashed #1f2937;
    }

    .admin-panel {
      margin-top: 0.75rem;
      display: none;
    }

    .admin-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .admin-row input[type="password"] {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 0.35rem 0.9rem;
      font-size: 0.9rem;
    }

    .admin-row input[type="password"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    .admin-label {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .admin-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.3rem;
    }

    .btn-secondary {
      background: #111827;
      border: 1px solid #1f2937;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
        <div>
          <h1>AI vs Human Text Detector</h1>
          <p class="subtitle">
            Paste any English text and the model will predict whether it’s
            <strong>AI-generated</strong> or <strong>Human-written</strong>, with a confidence score.
          </p>
        </div>
        <div class="badge" id="healthBadge">
          <span class="badge-dot" id="healthDot"></span>
          <span id="healthText">Checking server…</span>
        </div>
      </div>

      <label for="inputText">Paste or type your text</label>
      <textarea id="inputText" placeholder="Write or paste a paragraph, then click &quot;Detect Origin&quot;..."></textarea>
      <div class="hint">Minimum length: 250 characters.</div>

      <div class="controls">
        <button id="detectBtn">
          <span id="btnText">Detect Origin</span>
        </button>
        <span class="status" id="statusText"></span>
      </div>

      <div id="errorBox" class="error" style="display:none;"></div>

      <div id="resultCard" class="result-card" style="display:none;">
        <div class="result-title">Prediction</div>
        <div id="resultLabel" class="result-label">—</div>
        <div id="resultMeta" class="result-meta">—</div>

        <!-- Feedback section -->
        <div id="feedbackSection" class="feedback-section" style="display:none;">
          <div class="feedback-title">Help improve the model</div>
          <div class="feedback-row">
            <label for="feedbackLabel" style="margin:0;">True origin (your judgment):</label>
            <select id="feedbackLabel">
              <option value="">Select...</option>
              <option value="Human">Human-written</option>
              <option value="AI">AI-generated</option>
            </select>
            <button id="sendFeedbackBtn" type="button">
              Send Feedback
            </button>
            <span id="feedbackStatus" class="status"></span>
          </div>
        </div>

        
      </div>
      <div class="admin-section">
          <button id="adminToggleBtn" type="button" class="btn-secondary">
            Admin tools
          </button>
          <div id="adminPanel" class="admin-panel">
            <div class="admin-row">
              <span class="admin-label">Admin password:</span>
              <input type="password" id="adminPassword" placeholder="••••" />
              <button id="adminUnlockBtn" type="button">Unlock</button>
              <button id="downloadCsvBtn" type="button" style="display:none;">
                Download feedback CSV
              </button>
            </div>
            <div class="admin-note">Default password for demo: 1234</div>
            <span id="adminStatus" class="status"></span>
          </div>
        </div>
    </div>
  </div>

  <script>
    const API_BASE = ""; // same origin (http://localhost:8000 or Railway URL)

    const inputText = document.getElementById("inputText");
    const detectBtn = document.getElementById("detectBtn");
    const btnText = document.getElementById("btnText");
    const statusText = document.getElementById("statusText");
    const errorBox = document.getElementById("errorBox");
    const resultCard = document.getElementById("resultCard");
    const resultLabel = document.getElementById("resultLabel");
    const resultMeta = document.getElementById("resultMeta");
    const healthDot = document.getElementById("healthDot");
    const healthText = document.getElementById("healthText");

    const feedbackSection = document.getElementById("feedbackSection");
    const feedbackLabel = document.getElementById("feedbackLabel");
    const sendFeedbackBtn = document.getElementById("sendFeedbackBtn");
    const feedbackStatus = document.getElementById("feedbackStatus");

    const adminToggleBtn = document.getElementById("adminToggleBtn");
    const adminPanel = document.getElementById("adminPanel");
    const adminPassword = document.getElementById("adminPassword");
    const adminUnlockBtn = document.getElementById("adminUnlockBtn");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const adminStatus = document.getElementById("adminStatus");

    let lastText = "";     // last text sent to /predict
    let adminUnlocked = false;
    let adminKey = "";     // store the correct password once entered

    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + "/health");
        if (!res.ok) throw new Error("Server not OK");
        const data = await res.json();
        healthDot.style.background = "#22c55e";
        healthText.textContent = "Online: " + (data.model || "model");
      } catch (e) {
        healthDot.style.background = "#f97373";
        healthText.textContent = "Offline";
      }
    }

    function setLoading(isLoading) {
      detectBtn.disabled = isLoading;
      btnText.textContent = isLoading ? "Analyzing..." : "Detect Origin";
      statusText.textContent = isLoading ? "Sending text to the model..." : "";
    }

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }

    function clearError() {
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    function showResult(prediction, confidence, score) {
      resultCard.style.display = "block";

      const isAI = prediction.toLowerCase().includes("ai");
      resultLabel.textContent = prediction;
      resultLabel.classList.remove("ai", "human");
      resultLabel.classList.add(isAI ? "ai" : "human");

      const confPercent = (confidence * 100).toFixed(2);
      resultMeta.textContent =
        "Confidence: " + confPercent + "%  •  Margin score: " + score.toFixed(4);

      // Enable feedback section after a prediction
      feedbackSection.style.display = "block";
      feedbackLabel.value = "";
      feedbackStatus.textContent = "";
    }

    async function handleDetect() {
      clearError();
      feedbackStatus.textContent = "";
      adminStatus.textContent = "";

      const text = inputText.value.trim();
      if (!text) {
        showError("Please enter some text first.");
        return;
      }

      if (text.length < 100) {
        showError("Please provide at least 100 characters for a meaningful prediction.");
        return;
      }

      setLoading(true);
      resultCard.style.display = "none";
      feedbackSection.style.display = "none";

      try {
        const res = await fetch(API_BASE + "/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showError(data.error || "Server returned an error.");
        } else {
          const prediction = data.prediction || "Unknown";
          const confidence = typeof data.confidence === "number" ? data.confidence : 0;
          const score = typeof data.score === "number" ? data.score : 0;
          lastText = text;
          showResult(prediction, confidence, score);
        }
      } catch (err) {
        showError("Failed to contact the server. Is api_server.py running?");
      } finally {
        setLoading(false);
      }
    }

    async function handleFeedback() {
      clearError();
      feedbackStatus.textContent = "";

      if (!lastText) {
        showError("Please get a prediction first before sending feedback.");
        return;
      }

      const trueLabel = feedbackLabel.value;
      if (!trueLabel) {
        showError("Please choose whether the text is Human-written or AI-generated.");
        return;
      }

      sendFeedbackBtn.disabled = true;
      feedbackStatus.textContent = "Sending feedback...";

      try {
        const res = await fetch(API_BASE + "/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: lastText,
            true_label: trueLabel   // "Human" or "AI" – server normalizes it
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showError(data.error || "Server rejected feedback.");
          feedbackStatus.textContent = "";
        } else {
          feedbackStatus.textContent = "Thank you! Your feedback was recorded.";
        }
      } catch (err) {
        showError("Failed to send feedback. Please try again later.");
        feedbackStatus.textContent = "";
      } finally {
        sendFeedbackBtn.disabled = false;
      }
    }

    function toggleAdminPanel() {
      if (adminPanel.style.display === "none" || adminPanel.style.display === "") {
        adminPanel.style.display = "block";
      } else {
        adminPanel.style.display = "none";
      }
    }

    function handleUnlockAdmin() {
      clearError();
      adminStatus.textContent = "";

      const pwd = adminPassword.value.trim();
      if (!pwd) {
        adminStatus.textContent = "Please enter the admin password.";
        return;
      }

      if (pwd === "1234") {
        adminUnlocked = true;
        adminKey = pwd;
        adminStatus.textContent = "Admin unlocked. You can now download the feedback CSV.";
        downloadCsvBtn.style.display = "inline-flex";
      } else {
        adminUnlocked = false;
        adminKey = "";
        downloadCsvBtn.style.display = "none";
        adminStatus.textContent = "Wrong password.";
      }
    }

    function handleDownloadCsv() {
      if (!adminUnlocked || !adminKey) {
        adminStatus.textContent = "Admin is not unlocked.";
        return;
      }
      // Trigger a file download from /download-feedback with the admin key
      const url = API_BASE + "/download-feedback?key=" + encodeURIComponent(adminKey);
      window.location.href = url;
    }

    detectBtn.addEventListener("click", handleDetect);
    sendFeedbackBtn.addEventListener("click", handleFeedback);
    adminToggleBtn.addEventListener("click", toggleAdminPanel);
    adminUnlockBtn.addEventListener("click", handleUnlockAdmin);
    downloadCsvBtn.addEventListener("click", handleDownloadCsv);

    inputText.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        handleDetect();
      }
    });

    // Check backend status on load
    checkHealth();
  </script>
</body>
</html>
